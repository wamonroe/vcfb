#!/bin/sh

remove_gemlock() {
  if [ -f Gemfile.lock ]; then
    rm Gemfile.lock
  fi
}

bundle_install() {
  bundle install --quiet
}

print_verions() {
  rails_version=`bundle info rails | head -1 | sed -nr "s/[^(]*\((.*)\)/\1/p"`
  ruby_version=`ruby -v | sed -nr "s/ruby ([^ p]+).*/\1/p"`
  view_component_version=`bundle info view_component | head -1 | sed -nr "s/[^(]*\((.*)\)/\1/p"`
  echo "Running tests for Ruby $ruby_version, Rails $rails_version, and ViewComponent $view_component_version"
}

run_rspec() {
  bin/rspec --require ./spec/bulk_test_formatter.rb --format BulkTestFormatter
}

use_ruby_version() {
  if [ -z $(asdf list ruby | grep $1) ]; then
    asdf install ruby $1
  fi
  asdf local ruby $1
}

run_tests() {
  export RAILS_VERSION=$1
  export VIEW_COMPONENT_VERSION=$2
  remove_gemlock && bundle_install && print_verions && run_rspec
}

reset_env() {
  asdf local ruby latest
  unset RAILS_VERSION
  unset VIEW_COMPONENT_VERSION
  remove_gemlock && bundle_install && remove_gemlock
}

ruby_versions=(2.7.6 3.0.4 3.1.2)
rails_versions=(6.1.0 7.0.0)
view_component_versions=(2.35.0 2.45.0 2.55.0 2.56.0 2.57.0)
# view_component_versions=(2.35.0 2.36.0 2.37.0 2.38.0 2.39.0 2.40.0 2.41.0 2.42.0 2.43.0 2.44.0 2.45.0 2.46.0 2.47.0 2.48.0 2.49.0 2.50.0 2.51.0 2.52.0 2.53.0 2.54.0 2.55.0 2.56.0 2.57.0)

# Run Tests
for ruby_version in ${ruby_versions[@]}; do
  use_ruby_version $ruby_version

  for rails_version in ${rails_versions[@]}; do
    for view_component_version in ${view_component_versions[@]}; do      
      run_tests $rails_version $view_component_version
    done
  done
done

# Reset Environment
reset_env
